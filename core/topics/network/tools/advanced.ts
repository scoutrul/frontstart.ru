import { Topic } from '../../../types';

export const NETWORK_TOOLS_ADVANCED_TOPICS: Topic[] = [
  {
    id: 'network-production',
    title: 'Анализ сетевых проблем в продакшене',
    difficulty: 'advanced',
    description: 'Анализ сетевых проблем в продакшене требует системного подхода: сбор метрик, мониторинг, логирование, анализ паттернов. Используются инструменты: RUM (Real User Monitoring), APM (Application Performance Monitoring), логи сервера, аналитика браузеров. Важно различать проблемы сети, сервера, клиента и понимать контекст (география, устройства, браузеры). Методология диагностики: сбор данных → анализ паттернов → выявление причин → решение.',
    keyPoints: [
      'RUM (Real User Monitoring): сбор метрик от реальных пользователей, показывает реальную производительность.',
      'APM (Application Performance Monitoring): мониторинг серверной части, помогает найти узкие места в коде и БД.',
      'Логирование: структурированные логи запросов с таймингами, статусами, ошибками для анализа паттернов.',
      'Метрики: TTFB, время ответа, частота ошибок, throughput, latency по регионам и устройствам.',
      'Паттерны: анализ временных паттернов (пики нагрузки), географических (медленные регионы), по типам запросов.',
      'Диагностика: системный подход — сбор данных → анализ → гипотезы → проверка → решение → мониторинг результата.'
    ],
    tags: ['networks', 'monitoring', 'production', 'rum', 'apm', 'advanced'],
    examples: [
      {
        title: 'RUM (Real User Monitoring)',
        code: `// RUM собирает метрики от реальных пользователей:
// - Время загрузки страницы
// - TTFB
// - Время ответа API
// - Частота ошибок
// - География пользователей
// - Устройства и браузеры

// ИНСТРУМЕНТЫ:
// - Google Analytics
// - New Relic Browser
// - Datadog RUM
// - Sentry Performance

// ПРИМЕР СБОРА:
performance.getEntriesByType('resource').forEach(entry => {
  if (entry.name.includes('/api/')) {
    // Отправить метрики:
    // - entry.responseStart - TTFB
    // - entry.duration - общее время
    // - entry.transferSize - размер
    sendMetric({
      url: entry.name,
      ttfb: entry.responseStart,
      duration: entry.duration
    });
  }
});

// АНАЛИЗ:
// - Медленные запросы
// - Высокий TTFB
// - Ошибки по регионам
// - Проблемы на мобильных`
      },
      {
        title: 'APM (Application Performance Monitoring)',
        code: `// APM мониторит серверную часть:
// - Время выполнения запросов
// - Запросы к БД
// - Внешние API вызовы
// - Использование памяти/CPU
// - Ошибки и исключения

// ИНСТРУМЕНТЫ:
// - New Relic APM
// - Datadog APM
// - AppDynamics
// - Elastic APM

// ПРИМЕР ЛОГИРОВАНИЯ:
app.get('/api/users', async (req, res) => {
  const start = Date.now();
  try {
    const users = await db.users.findMany();
    const duration = Date.now() - start;
    
    // Логирование:
    logger.info({
      endpoint: '/api/users',
      duration,
      dbQueries: 1,
      status: 200
    });
    
    res.json(users);
  } catch (error) {
    logger.error({
      endpoint: '/api/users',
      error: error.message,
      status: 500
    });
    res.status(500).json({ error: 'Internal error' });
  }
});

// АНАЛИЗ:
// - Медленные endpoints
// - Проблемы с БД
// - Внешние API задержки
// - Узкие места в коде`
      },
      {
        title: 'Структурированное логирование',
        code: `// СТРУКТУРИРОВАННЫЕ ЛОГИ для анализа:

// ФОРМАТ JSON:
{
  "timestamp": "2024-01-15T10:30:00Z",
  "level": "info",
  "request": {
    "method": "GET",
    "url": "/api/users",
    "status": 200,
    "duration": 150,
    "ttfb": 120
  },
  "user": {
    "id": "123",
    "region": "US"
  },
  "server": {
    "host": "api-01",
    "cpu": 45,
    "memory": 60
  }
}

// АНАЛИЗ ЛОГОВ:
// 1. Поиск медленных запросов:
//    duration > 1000ms

// 2. Анализ по регионам:
//    region = "EU" AND duration > 500ms

// 3. Поиск ошибок:
//    status >= 500

// 4. Паттерны нагрузки:
//    GROUP BY hour, COUNT(*)

// ИНСТРУМЕНТЫ:
// - ELK Stack (Elasticsearch, Logstash, Kibana)
// - Splunk
// - Datadog Logs
// - CloudWatch Logs`
      },
      {
        title: 'Методология диагностики',
        code: `// СИСТЕМНЫЙ ПОДХОД:

// 1. СБОР ДАННЫХ:
//    - RUM метрики
//    - APM данные
//    - Логи сервера
//    - Логи CDN/прокси
//    - Мониторинг инфраструктуры

// 2. АНАЛИЗ ПАТТЕРНОВ:
//    - Временные (пики нагрузки)
//    - Географические (медленные регионы)
//    - По типам запросов (API медленнее)
//    - По устройствам (мобильные медленнее)

// 3. ВЫЯВЛЕНИЕ ПРИЧИН:
//    - Высокий TTFB → проблемы сервера
//    - Медленный DNS → проблемы DNS
//    - Ошибки 5xx → проблемы сервера
//    - Ошибки 4xx → проблемы клиента
//    - Медленная загрузка → большие файлы

// 4. ГИПОТЕЗЫ И ПРОВЕРКА:
//    - Гипотеза: сервер перегружен
//    - Проверка: CPU/memory метрики
//    - Решение: масштабирование

// 5. РЕАЛИЗАЦИЯ И МОНИТОРИНГ:
//    - Внедрить решение
//    - Мониторить метрики
//    - Проверить улучшение`
      },
      {
        title: 'Типичные проблемы и решения',
        code: `// ПРОБЛЕМА: Высокий TTFB
// СИМПТОМЫ: TTFB > 1000ms
// ПРИЧИНЫ: медленный сервер, перегрузка БД, отсутствие кеша
// РЕШЕНИЕ:
// - Оптимизировать код
// - Кешировать ответы
// - Масштабировать сервер
// - Использовать CDN

// ПРОБЛЕМА: Медленная загрузка ресурсов
// СИМПТОМЫ: долгий Content Download
// ПРИЧИНЫ: большие файлы, медленная сеть
// РЕШЕНИЕ:
// - Сжимать ресурсы
// - Использовать современные форматы
// - Lazy loading
// - CDN

// ПРОБЛЕМА: Ошибки 5xx
// СИМПТОМЫ: высокая частота 500/502/503
// ПРИЧИНЫ: ошибки в коде, перегрузка, проблемы БД
// РЕШЕНИЕ:
// - Исправить баги
// - Добавить retry логику
// - Масштабировать
// - Мониторить ошибки

// ПРОБЛЕМА: CORS ошибки
// СИМПТОМЫ: блокировка запросов
// ПРИЧИНЫ: неправильная настройка CORS
// РЕШЕНИЕ:
// - Настроить CORS заголовки
// - Проверить preflight запросы
// - Использовать правильные origins`
      }
    ],
    relatedTopics: ['network-timing', 'network-waterfall', 'core-web-vitals']
  }
];
