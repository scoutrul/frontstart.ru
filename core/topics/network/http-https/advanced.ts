import { Topic } from '../../../types';

export const NETWORK_HTTP_HTTPS_ADVANCED_TOPICS: Topic[] = [
  {
    id: 'http-versions',
    title: 'HTTP/1.1 vs HTTP/2 vs HTTP/3',
    difficulty: 'advanced',
    description: 'HTTP эволюционировал от версии 1.1 к 2 и 3, решая проблемы производительности. HTTP/1.1 имеет ограничения: одно соединение на домен, head-of-line blocking. HTTP/2 добавляет мультиплексирование, приоритизацию и сжатие заголовков. HTTP/3 использует QUIC поверх UDP, устраняя head-of-line blocking на транспортном уровне. Понимание различий важно для оптимизации производительности.',
    keyPoints: [
      'HTTP/1.1: текстовый протокол, одно соединение на домен, head-of-line blocking, нет сжатия заголовков.',
      'HTTP/2: бинарный протокол, мультиплексирование потоков, приоритизация, сжатие заголовков (HPACK), server push.',
      'HTTP/3: QUIC поверх UDP, встроенный TLS 1.3, мультиплексирование без head-of-line blocking, быстрая установка соединения.',
      'Мультиплексирование: HTTP/2 и HTTP/3 позволяют несколько запросов в одном соединении.',
      'Head-of-line blocking: HTTP/1.1 и HTTP/2 страдают от блокировки на уровне TCP, HTTP/3 решает это через QUIC.',
      'Обратная совместимость: все версии работают параллельно, сервер выбирает версию через ALPN.'
    ],
    tags: ['networks', 'http', 'http2', 'http3', 'performance', 'quic', 'advanced'],
    examples: [
      {
        title: 'HTTP/1.1 — ограничения',
        code: `// HTTP/1.1 проблемы:
// 1. Одно соединение на домен (или несколько, но ограничено)
// 2. Head-of-line blocking
// 3. Нет сжатия заголовков
// 4. Текстовый протокол (больше overhead)

// Пример: загрузка 6 ресурсов
// Соединение 1: [запрос 1] → [ответ 1] → [запрос 2] → [ответ 2] → ...
// Каждый запрос ждёт завершения предыдущего

// Решение: множественные соединения (обычно 6 на домен)
// Соединение 1: [запрос 1] → [ответ 1]
// Соединение 2: [запрос 2] → [ответ 2]
// Соединение 3: [запрос 3] → [ответ 3]
// ... но это создаёт overhead на установку соединений`
      },
      {
        title: 'HTTP/2 — мультиплексирование',
        code: `// HTTP/2 преимущества:
// 1. Мультиплексирование: несколько запросов в одном соединении
// 2. Приоритизация потоков
// 3. Сжатие заголовков (HPACK)
// 4. Server Push (отправка ресурсов до запроса)
// 5. Бинарный протокол (меньше overhead)

// Пример: загрузка 6 ресурсов
// Одно соединение:
// [поток 1: запрос] [поток 2: запрос] [поток 3: запрос]
// [поток 1: ответ] [поток 2: ответ] [поток 3: ответ]
// Все потоки обрабатываются параллельно

// ПРОБЛЕМА: Head-of-line blocking на уровне TCP
// Если пакет потока 1 потерян, все потоки блокируются
// TCP гарантирует порядок, поэтому ждёт потерянный пакет`
      },
      {
        title: 'HTTP/3 — QUIC поверх UDP',
        code: `// HTTP/3 решает проблемы HTTP/2:
// 1. QUIC поверх UDP (нет head-of-line blocking TCP)
// 2. Встроенный TLS 1.3 (меньше round-trips)
// 3. Мультиплексирование на уровне QUIC
// 4. Быстрая установка соединения (0-RTT для повторных)

// Пример: загрузка 6 ресурсов
// QUIC-соединение:
// [поток 1: запрос] [поток 2: запрос] [поток 3: запрос]
// [поток 1: ответ] [поток 2: ответ] [поток 3: ответ]
// Если пакет потока 1 потерян:
// - Только поток 1 блокируется
// - Потоки 2, 3 продолжают работать

// УСТАНОВКА СОЕДИНЕНИЯ:
// HTTP/2: TCP (1 RTT) + TLS (2 RTT) = 3 RTT
// HTTP/3: QUIC с TLS (1 RTT) = 1 RTT
// Повторное: HTTP/3 может использовать 0-RTT`
      },
      {
        title: 'Сравнение производительности',
        code: `// ЗАГРУЗКА 100 РЕСУРСОВ:

// HTTP/1.1:
// - 6 соединений параллельно
// - Каждое соединение последовательно
// - Время: ~16.7 секунд (100/6 запросов последовательно)

// HTTP/2:
// - 1 соединение, мультиплексирование
// - Все запросы параллельно
// - Время: ~1.7 секунд (но head-of-line blocking при потере пакетов)

// HTTP/3:
// - 1 соединение, мультиплексирование
// - Все запросы параллельно
// - Время: ~1.7 секунд (без head-of-line blocking)

// РЕАЛЬНЫЙ МИР:
// - HTTP/2 лучше на стабильных сетях
// - HTTP/3 лучше на нестабильных (мобильные, Wi-Fi)
// - HTTP/1.1 всё ещё используется (старые клиенты/серверы)`
      },
      {
        title: 'Server Push в HTTP/2',
        code: `// Server Push: сервер отправляет ресурсы до запроса клиента
// Клиент запрашивает HTML
// Сервер отправляет HTML + CSS + JS (которые понадобятся)

// Пример:
// Клиент: GET /index.html
// Сервер: 
//   - Отправляет index.html
//   - Push: /style.css (Link: </style.css>; rel=preload)
//   - Push: /script.js (Link: </script.js>; rel=preload)

// ПРОБЛЕМЫ:
// - Сервер может отправить ресурсы, которые уже в кеше
// - Клиент может отменить push (RST_STREAM)
// - Сложно определить, что нужно push-ить

// ПРАКТИКА:
// - Server Push редко используется
// - Лучше использовать <link rel=preload> в HTML`
      },
      {
        title: 'Выбор версии протокола',
        code: `// Сервер и клиент договариваются через ALPN (Application-Layer Protocol Negotiation)
// Клиент отправляет список поддерживаемых протоколов:
// - h2 (HTTP/2)
// - h3 (HTTP/3)
// - http/1.1

// Сервер выбирает лучший поддерживаемый протокол

// ПРАКТИКА:
// - Поддержка HTTP/2: ~95% браузеров
// - Поддержка HTTP/3: ~80% браузеров (растёт)
// - Fallback: HTTP/2 → HTTP/1.1

// НАСТРОЙКА:
// Nginx: listen 443 ssl http2;
// Cloudflare: автоматически использует HTTP/3 если доступно
// Chrome: chrome://flags/#enable-quic`
      }
    ],
    relatedTopics: ['http-over-tcp', 'tls-handshake', 'performance-multiplexing']
  },
  {
    id: 'tls-handshake',
    title: 'TLS-рукопожатие',
    difficulty: 'advanced',
    description: 'TLS-рукопожатие — процесс установки зашифрованного соединения между клиентом и сервером. Включает обмен сертификатами, согласование шифров, генерацию ключей. Классическое рукопожатие занимает 2 round-trips (RTT), TLS 1.3 оптимизирован до 1 RTT, а повторные соединения могут использовать 0-RTT. Понимание рукопожатия важно для оптимизации производительности HTTPS.',
    keyPoints: [
      'Классическое рукопожатие (TLS 1.2): ClientHello → ServerHello → KeyExchange → 2 RTT.',
      'TLS 1.3 оптимизация: объединение сообщений, 1 RTT для новых соединений.',
      '0-RTT: повторные соединения могут отправлять данные сразу, если сервер помнит ключи.',
      'Сертификаты: сервер отправляет цепочку сертификатов, клиент проверяет подпись CA.',
      'Шифры: согласование алгоритмов шифрования, хеширования, обмена ключами.',
      'Производительность: рукопожатие добавляет задержку, но современные оптимизации минимизируют её.'
    ],
    tags: ['networks', 'https', 'tls', 'ssl', 'security', 'performance', 'advanced'],
    examples: [
      {
        title: 'TLS 1.2 рукопожатие (2 RTT)',
        code: `// RTT 1: Клиент → Сервер
// ClientHello:
//   - Поддерживаемые версии TLS
//   - Поддерживаемые шифры
//   - Случайное число (Client Random)

// RTT 1: Сервер → Клиент
// ServerHello:
//   - Выбранная версия TLS
//   - Выбранный шифр
//   - Случайное число (Server Random)
// Certificate:
//   - Сертификат сервера
//   - Цепочка сертификатов
// ServerKeyExchange:
//   - Параметры для обмена ключами
// ServerHelloDone

// RTT 2: Клиент → Сервер
// ClientKeyExchange:
//   - Зашифрованный предмастер-ключ
// ChangeCipherSpec:
//   - Переход на зашифрованное соединение
// Finished:
//   - Проверка целостности

// RTT 2: Сервер → Клиент
// ChangeCipherSpec
// Finished

// ИТОГО: 2 RTT до первого байта данных`
      },
      {
        title: 'TLS 1.3 рукопожатие (1 RTT)',
        code: `// TLS 1.3 оптимизирован:
// - Объединение сообщений
// - Удалены ненужные шаги
// - Более эффективный обмен ключами

// RTT 1: Клиент → Сервер
// ClientHello:
//   - Поддерживаемые версии (только 1.3)
//   - Поддерживаемые шифры
//   - Client Random
//   - Предполагаемые параметры ключа

// RTT 1: Сервер → Клиент
// ServerHello:
//   - Выбранная версия (1.3)
//   - Выбранный шифр
//   - Server Random
//   - Параметры ключа
// Certificate:
//   - Сертификат сервера
//   - Цепочка сертификатов
// CertificateVerify:
//   - Подпись сертификата
// Finished:
//   - Проверка целостности

// Клиент вычисляет ключи и отправляет:
// ChangeCipherSpec
// Finished

// ИТОГО: 1 RTT до первого байта данных`
      },
      {
        title: '0-RTT для повторных соединений',
        code: `// TLS 1.3 поддерживает 0-RTT:
// Клиент может отправить данные сразу,
// если сервер помнит предыдущее соединение

// ПЕРВОЕ СОЕДИНЕНИЕ:
// Клиент → Сервер: ClientHello
// Сервер → Клиент: ServerHello + сертификат
// Сервер сохраняет ключи (ticket)

// ПОВТОРНОЕ СОЕДИНЕНИЕ:
// Клиент → Сервер: ClientHello + Early Data (данные сразу)
// Сервер проверяет ticket и принимает данные
// Сервер → Клиент: ServerHello + Finished

// ИТОГО: 0 RTT до первого байта данных

// ОГРАНИЧЕНИЯ:
// - Только для безопасных запросов (GET, безопасные заголовки)
// - Сервер может отклонить 0-RTT и запросить полное рукопожатие
// - Риск replay-атак (повторная отправка перехваченных данных)`
      },
      {
        title: 'Проверка сертификата',
        code: `// Клиент проверяет сертификат:
// 1. Сертификат действителен (не истёк)
// 2. Сертификат подписан доверенным CA
// 3. Доменное имя совпадает (CN или SAN)
// 4. Сертификат не отозван (OCSP или CRL)

// ЦЕПОЧКА СЕРТИФИКАТОВ:
// example.com (сертификат сервера)
//   ↓ подписан
// Intermediate CA (промежуточный CA)
//   ↓ подписан
// Root CA (корневой CA, встроен в браузер)

// Браузер проверяет всю цепочку до корневого CA

// ОШИБКИ:
// - Сертификат истёк → "Ваше соединение не защищено"
// - Неизвестный CA → предупреждение
// - Несовпадение домена → ошибка`
      },
      {
        title: 'Влияние на производительность',
        code: `// ЗАДЕРЖКА TLS-РУКОПОЖАТИЯ:
// TLS 1.2: ~200-300ms (2 RTT)
// TLS 1.3: ~100-150ms (1 RTT)
// TLS 1.3 0-RTT: ~0ms (для повторных)

// ОПТИМИЗАЦИИ:
// 1. TLS Session Resumption
//    - Сохранение сессии для повторного использования
//    - Session ID или Session Tickets

// 2. HTTP/2 Server Push
//    - Отправка ресурсов до запроса
//    - Компенсирует задержку рукопожатия

// 3. Preconnect
//    - <link rel="preconnect" href="https://api.example.com">
//    - Устанавливает соединение заранее

// 4. CDN с близкими серверами
//    - Уменьшает RTT (задержку сети)`
      }
    ],
    relatedTopics: ['https-basics', 'http-versions', 'performance-prefetch']
  }
];
