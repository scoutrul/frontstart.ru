/**
 * Скрипт для генерации индекса topicId → metaCategoryId
 * Запускать: npm run generate-topic-index (или tsx scripts/generate-topic-index.js)
 * Результат: core/topicIndex.ts
 */

import { getAllTopicsWithMeta } from '../core/getAllTopics.ts';
import { writeFile } from 'fs/promises';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const OUTPUT_FILE = join(__dirname, '..', 'core', 'topicIndex.ts');

async function generateTopicIndex() {
  try {
    console.log('Generating topic index...');
    
    const topicsWithMeta = getAllTopicsWithMeta();
    
    // Создаем индекс topicId → metaCategoryId
    const topicToMeta = {};
    const topicToCategory = {};
    
    // Подсчитываем количество тем в каждой метакатегории
    const metaCategoryTopicCounts = {};
    
    topicsWithMeta.forEach(({ topic, metaCategoryId, category }) => {
      topicToMeta[topic.id] = metaCategoryId;
      topicToCategory[topic.id] = category.id;
      
      // Считаем темы
      if (!metaCategoryTopicCounts[metaCategoryId]) {
        metaCategoryTopicCounts[metaCategoryId] = 0;
      }
      metaCategoryTopicCounts[metaCategoryId]++;
    });
    
    // Генерируем TypeScript файл
    const content = `// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by scripts/generate-topic-index.js
// Run: npm run generate-topic-index

import { MetaCategoryId } from './metaCategories';

/**
 * Индекс для быстрого поиска метакатегории по ID темы
 * Используется для навигации и lazy-loading чанков
 */
export const TOPIC_TO_META: Record<string, MetaCategoryId> = ${JSON.stringify(topicToMeta, null, 2)} as const;

/**
 * Индекс для быстрого поиска категории по ID темы
 */
export const TOPIC_TO_CATEGORY: Record<string, string> = ${JSON.stringify(topicToCategory, null, 2)} as const;

/**
 * Количество тем в каждой метакатегории (для прогресса без загрузки данных)
 */
export const META_CATEGORY_TOPIC_COUNTS: Record<MetaCategoryId, number> = ${JSON.stringify(metaCategoryTopicCounts, null, 2)} as const;

/**
 * Получить метакатегорию темы по её ID
 */
export function getTopicMetaCategory(topicId: string): MetaCategoryId | null {
  return TOPIC_TO_META[topicId] || null;
}

/**
 * Получить категорию темы по её ID
 */
export function getTopicCategoryId(topicId: string): string | null {
  return TOPIC_TO_CATEGORY[topicId] || null;
}

/**
 * Получить количество тем в метакатегории без загрузки данных
 */
export function getMetaCategoryTopicCount(metaCategoryId: MetaCategoryId): number {
  return META_CATEGORY_TOPIC_COUNTS[metaCategoryId] || 0;
}
`;
    
    await writeFile(OUTPUT_FILE, content, 'utf-8');
    
    console.log(`✅ Generated topic index with ${Object.keys(topicToMeta).length} topics`);
    console.log(`   Output: ${OUTPUT_FILE}`);
    console.log(`   Meta categories: ${new Set(Object.values(topicToMeta)).size}`);
    console.log(`   Topic counts per meta category:`, metaCategoryTopicCounts);
  } catch (error) {
    console.error('Error generating topic index:', error);
    process.exit(1);
  }
}

generateTopicIndex();
